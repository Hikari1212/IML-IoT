<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>部員管理</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div id="hamburger-menu-button">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <nav id="side-nav">
        <ul>
            <div>
                <li><a href="#" id="nav-link-all-features">すべての機能</a></li>
                <li><a href="#" id="nav-link-members">部員管理</a></li>
                <li><a href="#" id="nav-link-admins">管理者管理</a></li>
                <li><a href="#" id="nav-link-logs">入退室ログ</a></li>
                <li><a href="#" id="nav-link-analytics">分析</a></li>
                <li><a href="#" id="nav-link-discord">Discord連携</a></li>
                <li><a href="#" id="nav-link-help">ヘルプ</a></li>
            </div>
            <div class="nav-bottom-links">
                <li><a href="/index.html" target="_blank" rel="noopener noreferrer" class="external-link">サークル在室状況</a>
                </li>
                <li><a href="/kiosk.html" target="_blank" rel="noopener noreferrer" class="external-link">キオスク画面</a>
                </li>
                <li><a href="/register.html" target="_blank" rel="noopener noreferrer"
                        class="external-link">部員名簿登録(一般)</a></li>
                <li><a href="https://scrapbox.io/imedia-lab/%E9%83%A8%E5%AE%A4%E5%9C%A8%E5%AE%A4%E7%AE%A1%E7%90%86%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0"
                        target="_blank" rel="noopener noreferrer" class="external-link">管理用資料</a></li>
                <li><a href="#" id="logout-link">ログアウト</a></li>
            </div>
        </ul>
    </nav>

    <h1>管理ページ</h1>

    <a href="#" id="home-button" style="display: none;" title="すべての機能に戻る">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
    </a>

    <div class="container" class="container">
        <div id="login-form" class="panel" style="max-width: 450px;">
            <h2>管理者ログイン</h2>
            <input type="email" id="login-email" placeholder="メールアドレス" required>
            <input type="password" id="login-password" placeholder="パスワード" required>
            <button id="login-button">ログイン</button>
        </div>
    </div>
    <div id="main-content" style="display: none;">
        <div class="container">
            <div id="all-features-panel" class="panel content-panel">
                <h2>すべての機能</h2>
                <div class="feature-grid">
                    <div class="feature-card" data-panel="member-management-panel">
                        <h3>部員管理</h3>
                        <p>部員名簿の閲覧、追加、編集、削除を行います。</p>
                    </div>
                    <div class="feature-card" data-panel="admin-management-panel">
                        <h3>管理者管理</h3>
                        <p>この管理画面にログインするユーザーを管理します。</p>
                    </div>
                    <div class="feature-card" data-panel="biometric-enrollment-panel">
                        <h3>生体情報登録</h3>
                        <p>部員の指紋や顔情報を登録する専用ページです。</p>
                    </div>
                    <div class="feature-card" data-panel="activity-log-panel">
                        <h3>入退室ログ</h3>
                        <p>キオスク端末からの入退室履歴を確認します。</p>
                    </div>
                    <div class="feature-card" data-panel="analytics-panel">
                        <h3>利用状況分析</h3>
                        <p>ログデータを基に滞在時間などをグラフで可視化します。</p>
                    </div>
                    <div class="feature-card" data-panel="discord-integration-panel">
                        <h3>Discord連携</h3>
                        <p>名簿とDiscordサーバーのロール連携を設定します。</p>
                    </div>
                    <div class="feature-card" data-panel="api-key-panel">
                        <h3>APIキー管理</h3>
                        <p>外部連携用のAPIキーを生成・管理します。</p>
                    </div>
                    <div class="feature-card" data-panel="help-panel">
                        <h3>ヘルプ</h3>
                        <p>このシステムの機能説明や使い方を確認できます。</p>
                    </div>
                </div>
            </div>

            <div id="member-management-panel" class="panel content-panel" style="display: none;">
                <h2>部員管理</h2>
                <div class="panel" style="background-color: #f9f9f9; border-color: #e0e0e0; margin-top: 20px;">
                    <h3 style="margin-top: 0;">Excelから一括登録</h3>
                    <p style="font-size: 0.9em; color: #666;">
                        指定の形式のExcelファイルをアップロードして、複数の部員を一度に追加できます。既に同じ名前の部員がいる場合は、自動でスキップされます。</p>
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <input type="file" id="excel-file-input" accept=".xlsx, .xls">
                        <button id="import-excel-button">インポート実行</button>
                        <button id="download-template-button">テンプレートをダウンロード</button>
                    </div>
                </div>

                <hr>

                <form id="add-member-form">
                    <input type="text" id="new-member-name" placeholder="名前" required>
                    <input type="text" id="new-member-furigana" placeholder="フリガナ" required>
                    <input type="text" id="new-member-studentid" placeholder="学籍番号(7桁)" pattern="[0-9]{7}" maxlength="7"
                        required>
                    <input type="email" id="new-member-email" placeholder="メールアドレス">
                    <input type="text" id="new-member-discordid" placeholder="DiscordユーザーID" pattern="^\d{17,19}$"
                        title="DiscordユーザーIDは17桁から19桁の数字で入力してください。">
                    <select id="new-member-gender" required>
                        <option value="">性別を選択</option>
                        <option value="男性">男性</option>
                        <option value="女性">女性</option>
                        <option value="その他">その他</option>
                    </select>
                    <input type="number" id="new-member-age" placeholder="年齢">
                    <select id="new-member-grade" required>
                        <option value="">学年を選択</option>
                        <option value="B1">学部1年</option>
                        <option value="B2">学部2年</option>
                        <option value="B3">学部3年</option>
                        <option value="B4">学部4年</option>
                        <option value="M1">修士1年</option>
                        <option value="M2">修士2年</option>
                    </select>
                    <select id="new-member-category" required>
                        <option value="">類を選択</option>
                        <option value="Ⅰ類">Ⅰ類</option>
                        <option value="Ⅱ類">Ⅱ類</option>
                        <option value="Ⅲ類">Ⅲ類</option>
                    </select>
                    <input type="text" id="new-member-project" placeholder="所属プロジェクト">
                    <select id="new-member-expiry" required>
                        <option value="">有効期限を選択</option>
                        <option value="this-october">今年の10月末</option>
                        <option value="next-april">来年の4月末</option>
                        <option value="custom">年月日を指定</option>
                    </select>
                    <input type="date" id="new-member-custom-expiry" style="display: none;">
                    <button type="submit">部員を追加</button>
                </form>
                <hr>

                <div class="panel-header">
                    <h3>登録済み部員一覧</h3>
                    <button id="export-excel-button">Excel形式で出力</button>
                </div>
                <div id="list-controls" class="panel-header">
                    <input type="text" id="search-input" placeholder="名前, 学年, PJ, 年齢などで検索...">
                    <select id="sort-select">
                        <option value="name-asc">名前順 (昇順)</option>
                        <option value="name-desc">名前順 (降順)</option>
                        <option value="grade-asc">学年順 (昇順)</option>
                        <option value="grade-desc">学年順 (降順)</option>
                        <option value="age-asc">年齢順 (若い順)</option>
                        <option value="age-desc">年齢順 (年上順)</option>
                        <option value="project-asc">プロジェクト順</option>
                        <option value="expiry-asc">有効期限が近い順</option>
                        <option value="status">在室状況</option>
                    </select>
                </div>
                <div id="filter-controls" class="filter-grid">
                    <span class="filter-label">絞り込み</span>
                    <select id="filter-expired">
                        <option value="">有効/失効</option>
                        <option value="false">有効</option>
                        <option value="true">失効</option>
                    </select>
                    <select id="filter-status">
                        <option value="">在室状況</option>
                        <option value="in">在室</option>
                        <option value="out">不在</option>
                    </select>
                    <select id="filter-grade">
                        <option value="">学年</option>
                        <option value="B1">B1</option>
                        <option value="B2">B2</option>
                        <option value="B3">B3</option>
                        <option value="B4">B4</option>
                        <option value="M1">M1</option>
                        <option value="M2">M2</option>
                    </select>
                    <select id="filter-category">
                        <option value="">類</option>
                        <option value="Ⅰ類">Ⅰ類</option>
                        <option value="Ⅱ類">Ⅱ類</option>
                        <option value="Ⅲ類">Ⅲ類</option>
                    </select>
                    <select id="filter-project">
                        <option value="">プロジェクト</option>
                    </select>
                    <select id="filter-gender">
                        <option value="">性別</option>
                        <option value="男性">男性</option>
                        <option value="女性">女性</option>
                        <option value="その他">その他</option>
                    </select>
                    <select id="filter-age">
                        <option value="">年齢</option>
                        <option value="18">18歳</option>
                        <option value="19">19歳</option>
                        <option value="20">20歳</option>
                        <option value="21">21歳</option>
                        <option value="22">22歳</option>
                        <option value="23">23歳</option>
                        <option value="24">24歳</option>
                        <option value="25">25歳</option>
                        <option value="26+">26歳以上</option>
                    </select>
                </div>
                <div id="bulk-action-panel" class="panel"
                    style="display: none; background-color: #f0f4f8; margin-bottom: 15px; padding: 15px;">
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <strong id="selection-count">0件選択中</strong>
                        <select id="bulk-action-select">
                            <option value="">一括操作を選択</option>
                            <option value="update-expiry">有効期限を更新</option>
                            <option value="delete">削除</option>
                        </select>
                        <div id="bulk-expiry-controls" style="display: none; align-items: center; gap: 10px;">
                            <select id="bulk-expiry-select">
                                <option value="">期限を選択</option>
                                <option value="this-october">今年の10月末</option>
                                <option value="next-april">来年の4月末</option>
                                <option value="custom">年月日を指定</option>
                                <option value="expire-now">失効させる</option>
                            </select>
                            <input type="date" id="bulk-custom-expiry" style="display: none;">
                        </div>
                        <button id="bulk-apply-button">適用</button>
                    </div>
                </div>
                <div id="admin-member-list"></div>
            </div>

            <div id="admin-management-panel" class="panel content-panel" style="display: none;">
                <h2>管理者管理</h2>
                <div class="form-group">
                    <div class="panel" style="background-color: #f9f9f9; border-color: #e0e0e0; margin-top: 20px;">
                        <form id="add-admin-form">
                            <div class="form-group">
                                <h3 style="margin-top: 0;">新しい管理者を追加</h3>
                                <input type="email" id="new-admin-email" placeholder="新しい管理者のメールアドレス" required>
                            </div>
                            <div class="form-group">
                                <input type="password" id="new-admin-password" placeholder="初期パスワード (6文字以上)" required>
                            </div>
                            <button type="submit" id="add-admin-button">管理者として登録</button>
                        </form>
                    </div>
                    <hr>
                    <div class="form-group">
                        <h3>登録済み管理者一覧</h3>
                        <div id="admin-list">
                        </div>
                    </div>
                </div>
            </div>

            <div id="biometric-enrollment-panel" class="panel content-panel" style="display: none;">
                <h2>生体情報登録</h2>
                <p>部員を選択して、指紋または顔情報の登録トークンを生成します。</p>
                <div class="form-group">
                    <label for="biometric-member-select">部員を選択</label>
                    <select id="biometric-member-select" required>
                        <option value="">登録する部員を選択してください</option>
                    </select>
                </div>
                <div class="biometric-actions">
                    <button id="register-fingerprint-button">指紋を登録</button>
                    <button id="register-face-button">顔を登録</button>
                </div>
            </div>

            <div id="activity-log-panel" class="panel content-panel" style="display: none;">
                <h2>入退室ログ</h2>
                <div id="activity-log-controls" style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                    <select id="log-period-select">
                        <option value="1m">直近1か月</option>
                        <option value="3m">直近3か月</option>
                        <option value="1y">直近1年</option>
                        <option value="all">すべて</option>
                    </select>
                    <select id="log-page-size-select">
                        <option value="25">25件/ページ</option>
                        <option value="50">50件/ページ</option>
                        <option value="100">100件/ページ</option>
                    </select>
                </div>
                <div id="activity-log-list"></div>
                <div id="log-pagination-controls"
                    style="display: flex; justify-content: center; align-items: center; margin-top: 15px; gap: 10px;">
                    <button id="log-prev-button" disabled>前へ</button>
                    <span id="log-page-info"></span>
                    <button id="log-next-button" disabled>次へ</button>
                </div>
            </div>

            <div id="analytics-panel" class="panel content-panel" style="display: none;">
                <h2>利用状況分析 (直近1ヶ月)</h2>
                <div class="panel" style="background-color: #f9f9f9; border-color: #e0e0e0; margin-top: 20px;">
                    <canvas id="stay-duration-chart"></canvas>
                </div>
                <div class="panel" style="background-color: #f9f9f9; border-color: #e0e0e0; margin-top: 20px;">
                    <canvas id="entry-count-chart"></canvas>
                </div>
            </div>

            <div id="discord-integration-panel" class="panel content-panel" style="display: none;">
                <h2>Discord連携設定</h2>
                <form id="discord-settings-form">
                    <div class="form-group">
                        <label>「部員」ロール自動付与</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="discord-member-role-enabled">
                            <label for="discord-member-role-enabled" class="slider"></label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>「部内」ロール自動付与</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="discord-in-room-role-enabled">
                            <label for="discord-in-room-role-enabled" class="slider"></label>
                        </div>
                    </div>
                    <hr>
                    <div class="form-group">
                        <label for="discord-token">Discord Bot トークン</label>
                        <input type="password" id="discord-token" placeholder="Botのトークン" required>
                    </div>
                    <div class="form-group">
                        <label for="discord-server-id">サーバーID</label>
                        <input type="text" id="discord-server-id" placeholder="サーバーID" required pattern="^\d{17,19}$">
                    </div>
                    <div class="form-group">
                        <label for="discord-member-role-id">「部員」ロールID</label>
                        <input type="text" id="discord-member-role-id" placeholder="部員ロールのID" required
                            pattern="^\d{17,19}$">
                    </div>
                    <div class="form-group">
                        <label for="discord-in-room-role-id">「部内」ロールID</label>
                        <input type="text" id="discord-in-room-role-id" placeholder="部内ロールのID" required
                            pattern="^\d{17,19}$">
                    </div>
                    <button type="submit" id="save-discord-settings-button">Discord設定を保存</button>
                </form>
                <hr>
                <div class="form-group">
                    <label>手動同期</label>
                    <p style="font-size: 0.9em; color: #666; margin-top:0;">現在の部員名簿の状態を、全メンバーのDiscordロールに強制的に反映させます。</p>
                    <button type="button" id="manual-sync-button">今すぐ手動で同期する</button>
                </div>
            </div>

            <div id="help-panel" class="panel content-panel" style="display: none;">
                <h2>ヘルプ / 使い方</h2>
                <input type="search" id="help-search-input" placeholder="キーワードでヘルプ項目を検索...">

                <div class="help-topic">
                    <h3>部員管理</h3>
                    <p>部員の追加、情報編集、削除など、名簿に関する全ての操作を行います。</p>
                    <ul>
                        <li><strong>部員の追加:</strong> ページ上部のフォームに必要な情報を入力し、「部員を追加」ボタンを押します。キーボードの空きキーが自動的に割り当てられます。</li>
                        <li><strong>情報の編集:</strong> 一覧の各部員の右側にある「編集」ボタンを押すと、入力フォームが表示されます。変更後に「保存」を押してください。</li>
                        <li><strong>削除:</strong> 「編集」ボタンの隣にある「削除」ボタンから部員を削除できます。この操作は取り消せません。</li>
                        <li><strong>詳細情報の確認:</strong> 部員名の欄をクリックすると、学籍番号やDiscord IDなどの詳細情報が表示されます。</li>
                        <li><strong>絞り込みとソート:</strong> 一覧の上部にある検索窓やドロップダウンメニューで、表示する部員を絞り込んだり、並べ替えたりできます。</li>
                        <li><strong>一括操作:</strong>
                            各部員の左側にあるチェックボックスを選択すると、画面上部に「一括操作」パネルが表示されます。複数の部員の有効期限を一度に更新したり、まとめて削除したりできます。</li>
                        <li><strong>Excelインポート:</strong>
                            指定のテンプレートを使って、複数の部員を一度に登録できます。登録された部員は初期状態では「失効」になっているため、管理者が有効期限を設定する必要があります。</li>
                        <li><strong>Excelエクスポート:</strong> 現在の名簿情報をExcelファイルとしてダウンロードします。出力する項目や、失効部員を含めるかどうかを選択できます。
                        </li>
                    </ul>
                </div>
                <div class="help-topic">
                    <h3>管理者管理</h3>
                    <p>この管理ページにログインできる管理者アカウントを管理します。</p>
                    <ul>
                        <li><strong>管理者の追加:</strong> 新しい管理者のメールアドレスと初期パスワードを設定して登録します。登録された管理者は、次回からその情報でログインできます。</li>
                        <li><strong>管理者の削除:</strong> 既存の管理者を削除します。自分自身を削除することはできません。</li>
                    </ul>
                </div>
                <div class="help-topic">
                    <h3>入退室ログ</h3>
                    <p>キオスク端末での入退室操作の履歴を閲覧できます。</p>
                    <ul>
                        <li><strong>期間・件数指定:</strong> 表示するログの期間（直近1ヶ月、1年など）や、1ページに表示する件数を変更できます。</li>
                        <li><strong>ページ移動:</strong> ログが多い場合、リスト下部の「前へ」「次へ」ボタンでページを移動できます。</li>
                    </ul>
                </div>
                <div class="help-topic">
                    <h3>分析</h3>
                    <p>直近1ヶ月のログデータを基に、部室の利用状況をグラフで確認できます。</p>
                    <ul>
                        <li><strong>部室滞在時間ランキング:</strong> 部員ごとの合計滞在時間をグラフで表示します。</li>
                        <li><strong>部室入室回数ランキング:</strong> 部員ごとの合計入室回数をグラフで表示します。</li>
                    </ul>
                </div>
                <div class="help-topic">
                    <h3>Discord連携</h3>
                    <p>部員名簿とDiscordサーバーのロール（役割）を自動で連携させるための設定です。</p>
                    <ul>
                        <li><strong>ロール自動付与:</strong> 名簿で有効な部員に特定のロール（例: 「部員」ロール）を付与したり、在室中のメンバーに別のロール（例:
                            「部内」ロール）を付与したりできます。</li>
                        <li><strong>各種IDとトークン:</strong> 設定には、Discord
                            BotのトークンやサーバーID、ロールIDなど、専門的な情報が必要です。詳しくはサーバー管理者にご確認ください。</li>
                        <li><strong>手動同期:</strong> 「今すぐ手動で同期する」ボタンを押すと、現在の名簿の状態がDiscordサーバーの全メンバーに強制的に反映されます。</li>
                    </ul>
                </div>
                <div class="help-topic">
                    <h3>設定</h3>
                    <p>システムに関するその他の設定を行います。</p>
                    <ul>
                        <li><strong>部員名簿APIキー:</strong>
                            外部のプログラムから部員名簿の情報を安全に取得するためのAPIキーです。新しいキーを生成・更新できます。キーを更新した場合は、利用しているすべてのプログラムのキーを更新する必要があります。
                        </li>
                    </ul>
                </div>

            </div>

            <div id="api-key-panel" class="panel content-panel" style="display: none;">
                <h2>APIキー管理</h2>
                <div class="form-group">
                    <label>部員名簿APIキー</label>
                    <p style="font-size: 0.9em; color: #666; margin-top:0;">外部のプログラムから部員名簿の情報を安全に取得するためのAPIキーです。</p>
                    <div class="api-key-wrapper">
                        <input type="text" id="api-key-display" placeholder="APIキーが設定されていません" readonly>
                        <button type="button" id="update-api-key-button">新しいAPIキーを生成</button>
                    </div>
                </div>
                <hr>
                <div class="form-group">
                    <label>APIエンドポイントURL</label>
                    <p style="font-size: 0.9em; color: #666; margin-top:0;">部員名簿APIを呼び出すためのURLです。</p>
                    <div class="api-endpoint-wrapper">
                        <input type="text" id="api-endpoint-url"
                            value="https://asia-northeast1-iml-iot-sdkv9.cloudfunctions.net/getMemberListAPI" readonly>
                        <button type="button" id="copy-api-url-button">コピー</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="export-options-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content panel">
            <h3>Excelエクスポート設定</h3>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="export-exclude-expired" checked>
                    失効した部員を除外する
                </label>
            </div>
            <div class="form-group">
                <strong>出力する項目</strong>
                <div id="export-column-selection" class="checkbox-grid">
                </div>
            </div>
            <div class="modal-actions">
                <button id="execute-export-button" class="save-button">エクスポート実行</button>
                <button id="cancel-export-button" class="cancel-button">キャンセル</button>
            </div>
        </div>
    </div>

    <div id="token-display-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content panel">
            <h3>生体情報 登録準備完了</h3>
            <p>登録用デバイス（Raspberry Piなど）で、以下のトークンを入力してください。<br><strong>このトークンは5分間のみ有効です。</strong></p>
            <div class="token-display-box">
                <span id="token-display-text"></span>
            </div>
            <div class="modal-actions">
                <button id="close-token-modal-button" class="cancel-button">閉じる</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getFunctions } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCrG5mdVZZ9hKNpdG5WlRMsxnU7l51k1gA",
            authDomain: "iml-iot-sdkv9.firebaseapp.com",
            projectId: "iml-iot-sdkv9",
            storageBucket: "iml-iot-sdkv9.firebasestorage.app",
            messagingSenderId: "454858659417",
            appId: "1:454858659417:web:ba23b9ddd088a6af0c8348",
            measurementId: "G-S163PEYCK0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app, 'asia-northeast1');

        import { initAdminPage } from './admin.js';
        initAdminPage(auth, db, functions, window.XLSX, window.Chart);
    </script>
</body>

</html>