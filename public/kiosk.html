<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>入退室管理 キオスク</title>
    <link rel="stylesheet" href="style.css">
    <script src="face-api.min.js"></script>
</head>
<body>
    <div id="kiosk-panel" class="panel">
        <div class="kiosk-header">
            <h1>入退室管理</h1>
            <div id="daily-visitor-count"></div>
            <button id="start-face-enrollment-flow-button" class="btn btn-secondary">顔情報を登録する</button>
        </div>
        <div id="member-list">
            </div>
        <p style="text-align: center; margin-top: 20px;">
            キーボードの Enter キーを押すと、生体情報登録モードに切り替わります。
        </p>
    </div>

    <div id="enrollment-panel" class="panel" style="display: none;">
        <h2>顔情報の登録</h2>
        <p>管理者から発行されたトークンを入力し、「登録開始」ボタンを押してください。<br>カメラに顔をまっすぐ向けて、枠内に収まるようにしてください。</p>
        <div class="enrollment-container">
            <div class="camera-container">
                <video id="video" autoplay muted></video>
                <div id="face-overlay"></div>
                <div id="face-instruction-overlay" class="face-instruction-overlay"></div>
            </div>
            <div class="enrollment-controls">
                <div class="form-group">
                    <label for="enrollment-token">登録トークン</label>
                    <input type="text" id="enrollment-token" placeholder="管理者から受け取ったトークン">
                </div>
                <div class="enrollment-actions">
                    <button id="start-enrollment-button" class="btn btn-primary">登録開始</button>
                    <button id="back-to-kiosk-button" class="btn btn-secondary">入退室登録に戻る</button>
                </div>
                <p id="enrollment-status">準備完了</p>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getFunctions } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-functions.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCrG5mdVZZ9hKNpdG5WlRMsxnU7l51k1gA",
          authDomain: "iml-iot-sdkv9.firebaseapp.com",
          projectId: "iml-iot-sdkv9",
          storageBucket: "iml-iot-sdkv9.firebasestorage.app",
          messagingSenderId: "454858659417",
          appId: "1:454858659417:web:ba23b9ddd088a6af0c8348",
          measurementId: "G-S163PEYCK0"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const functions = getFunctions(app, 'asia-northeast1');

        // kiosk.js と kiosk_enroll.js をインポートして実行
        import { initKioskPage, showEnrollmentPanel, showKioskPanel } from './kiosk.js';
        import { initEnrollmentPage } from './kiosk_enroll.js';

        // 両方のページを初期化
        initKioskPage(db);
        initEnrollmentPage(db, functions);

        // Enterキーで画面を切り替えるイベントリスナー
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                // 現在表示されているパネルに応じて処理を切り替え
                const kioskPanel = document.getElementById('kiosk-panel');
                if (kioskPanel.style.display !== 'none') {
                    showEnrollmentPanel();
                }
            }
        });
    </script>
</body>
</html>